name: Package VS Code Extension

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Optional semver override (eg. 1.2.3). Leave empty to reuse package.json version.'
                required: false
                default: ''

jobs:
    package:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Override version
              if: ${{ inputs.version != '' }}
              run: npm version ${{ inputs.version }} --no-git-tag-version

            - name: Install VSCE
              run: npm install -g @vscode/vsce

            - name: Build production bundles
              run: npm run vscode:prepublish

            - name: Package extension
              id: package
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  vsce package --no-yarn --allow-star-activation --out "cph-${VERSION}.vsix"

            - name: Upload VSIX artifact
              uses: actions/upload-artifact@v4
              with:
                  name: cph-extension-${{ steps.package.outputs.version }}
                  path: cph-${{ steps.package.outputs.version }}.vsix
